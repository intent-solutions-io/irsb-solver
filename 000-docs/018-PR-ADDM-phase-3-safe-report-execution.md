# Phase 3 Addendum: SAFE_REPORT Execution

**Document ID:** 018-PR-ADDM-phase-3-safe-report-execution
**Repository:** irsb-solver
**Created:** 2026-02-05
**Status:** Complete

---

## Overview

Phase 3 implements the first real job runner: `SAFE_REPORT`. It produces deterministic artifacts (JSON + Markdown) without network calls or external dependencies.

---

## Job Type: SAFE_REPORT

### Purpose

Generates a deterministic report from provided subject and data. The report summarizes the input data in both JSON and Markdown formats.

### Inputs

```typescript
interface SafeReportInputs {
  subject: string;           // Report title
  data: Record<string, unknown>;  // Data to report on
}
```

### Outputs (Artifacts)

| File | Format | Content |
|------|--------|---------|
| `report.json` | JSON | Structured report with stats and metadata |
| `report.md` | Markdown | Human-readable report |

---

## Artifact Specifications

### report.json Schema

```typescript
interface SafeReportJson {
  subject: string;
  data: Record<string, unknown>;  // Canonicalized
  summary: string;
  stats: {
    keysCount: number;
    approxBytes: number;  // Canonical JSON length
  };
  generatedBy: {
    jobType: string;      // "SAFE_REPORT"
    intentId: string;
    runId: string;
    reportVersion: string;  // "0.1.0"
  };
}
```

### report.md Structure

```markdown
# SAFE_REPORT: {subject}

## Summary

{summary text}

## Data

- **key1**: value1
- **key2**: value2
...

---

_Generated by SAFE_REPORT | Intent: {intentId} | Run: {runId}_
```

---

## Determinism Rules

All outputs must be hash-stable across runs with identical inputs.

### Enforced Constraints

| Constraint | Implementation |
|------------|----------------|
| No timestamps | No Date.now(), no ISO timestamps in content |
| No random IDs | Only intentId/runId from intent |
| Stable JSON ordering | Canonical JSON with sorted keys |
| Stable Markdown ordering | Data keys sorted lexicographically |
| Consistent summary | Deterministic algorithm based on key count |

### Summary Generation Algorithm

```
if keys.length == 0:
  return "Empty data object - no keys to report."
else if keys.length <= 5:
  return "Report contains N key(s): {sorted_keys}."
else:
  return "Report contains N key(s). First 5: {first_5_sorted_keys}."
```

---

## Safety Constraints

SAFE_REPORT is designed to be inherently safe:

| Constraint | Enforcement |
|------------|-------------|
| No network calls | Pure computation only |
| No file reads | Only writes to artifacts dir |
| No external processes | No child_process usage |
| Bounded output | Size derived from input size |
| No secrets | Only processes provided data |

---

## CLI Integration

### run-fixture Command

```bash
pnpm cli run-fixture <intent-file>
```

**Process:**
1. Validate and normalize intent
2. Evaluate policy gate
3. If allowed, execute job runner
4. Write artifacts to `{DATA_DIR}/runs/{runId}/artifacts/`
5. Print run result JSON

**Exit Codes:**
| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | Error (config, parse, validation) |
| 2 | Policy refusal |
| 3 | Execution failure |

### Run Result Format

```json
{
  "intentId": "...",
  "runId": "...",
  "jobType": "SAFE_REPORT",
  "status": "SUCCESS",
  "artifacts": [
    { "path": "report.json", "bytes": 491 },
    { "path": "report.md", "bytes": 431 }
  ]
}
```

---

## Testing Requirements

### Determinism Tests

1. Run same fixture twice
2. Compare SHA256 of both artifacts
3. Hashes must be identical

### Safety Tests

1. Verify no timestamps in content
2. Verify writes only to artifacts directory
3. Verify no network activity

---

## Future Extensions

Phase 4+ will add:
- Evidence manifest with artifact hashing
- Receipt generation
- Evidence integrity verification

---

*End of Document*
